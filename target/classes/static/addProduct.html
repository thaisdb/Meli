<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product</title>
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Link to the header.js script -->
    <script src="header.js" defer></script>
</head>
<body data-title="Add Product" data-show-profile-icon="true" data-show-search-bar="false">
    <div class="header-placeholder"></div>

    <div class="card add-product-card">
        <h2>Add New Product</h2>
        <form id="addProductForm">
            <div class="form-group">
                <label for="title">Título:</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="price">Preço:</label>
                <input type="number" id="price" name="price" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="description">Descrição:</label>
                <textarea id="description" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="brand">Marca:</label>
                <input type="text" id="brand" name="brand">
            </div>
            <div class="form-group">
                <label for="stock">Quantidade em estoque:</label>
                <input type="number" id="stock" value="1" min="1" name="stock">
            </div>
            <div class="form-group">
                <label for="tags">Tags (separadas por ";"):</label>
                <input type="text" id="tags" name="tags">
            </div>
            <div class="form-group">
                <label for="imageUrl">URL da imagem:</label>
                <input type="url" id="imageUrl" name="imageUrl">
            </div>
            <button type="submit" class="button">Adicionar produto</button>
            <!-- Back link now includes sellerId for proper navigation -->
            <a href="/manageProducts.html?sellerId=" + window.loggedInUserId class="back-link">Voltar para página de gerenciamento de produtos</a>
        </form>
    </div>

    <!-- Product Added Confirmation Modal -->
    <div class="success-modal-overlay hidden app-modal-overlay">
        <div class="success-modal-content app-modal-content">
            <h2 class="success-modal-title app-modal-title">Produto adicionado com sucesso!</h2>
            <p class="success-modal-message app-modal-message">O que gostaria de fazer?</p>
            <div class="success-modal-actions app-modal-actions">
                <button id="addMoreProductsBtn" class="button add-more-button">Adicionar mais produtos</button>
                <button id="goToManageProductsBtn" class="button go-to-manage-button">Voltar para pagina de gerenciamento</button>
            </div>
        </div>
    </div>

    <script>
        // DOM element references for the new modal
        let successModalOverlay;
        let addMoreProductsBtn;
        let goToManageProductsBtn;

        // Get sellerId from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sellerIdFromUrl = urlParams.get('sellerId');

        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in and is a seller, and if sellerId is present
            if (!window.loggedInUserId || window.loggedInUserType !== 'seller' || !sellerIdFromUrl) {
                alert('Access Denied: You must be logged in as a seller to add products, and your seller ID must be provided.');
                window.location.href = '/login.html'; // Redirect to login if not a seller or no sellerId
                return;
            }
            // Ensure the back link is correctly set with the sellerId
            document.querySelector('.back-link').href = `/manageProducts.html?sellerId=${window.loggedInUserId}`;

            const addProductForm = document.getElementById('addProductForm');
            
            // Initialize new modal elements
            successModalOverlay = document.querySelector('.success-modal-overlay');
            addMoreProductsBtn = document.getElementById('addMoreProductsBtn');
            goToManageProductsBtn = document.getElementById('goToManageProductsBtn');

            // Add event listeners for the new modal buttons
            if (addMoreProductsBtn) {
                addMoreProductsBtn.addEventListener('click', () => {
                    console.log("FRONTEND: addProduct.html: 'Add More Products' clicked.");
                    successModalOverlay.classList.add('hidden'); // Hide the modal
                    addProductForm.reset(); // Clear the form
                });
            }

            if (goToManageProductsBtn) {
                goToManageProductsBtn.addEventListener('click', () => {
                    console.log("FRONTEND: addProduct.html: 'Go to Manage Products' clicked. Redirecting...");
                    successModalOverlay.classList.add('hidden'); // Hide the modal
                    window.location.href = `/manageProducts.html?sellerId=${window.loggedInUserId}`; // Redirect with sellerId
                });
            }

            if (addProductForm) {
                addProductForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    const formData = new FormData(addProductForm);
                    const productData = {};
                    formData.forEach((value, key) => {
                        if (key === 'price') {
                            // Convert to float, if empty string, set to null
                            productData[key] = value !== '' ? parseFloat(value) : null;
                        } else if (key === 'stock') {
                            // Convert to int, if empty string, set to null
                            productData[key] = value !== '' ? parseInt(value) : null;
                        } else if (key === 'tags') {
                            productData[key] = value.split(';').map(tag => tag.trim()).filter(tag => tag !== '');
                        } else {
                            productData[key] = value !== '' ? value : null;
                        }
                    });

                    // Add the sellerId to the product data
                    productData.sellerId = parseInt(sellerIdFromUrl); // Ensure it's an integer

                    console.log("FRONTEND: addProduct.html: Product data being sent:", JSON.stringify(productData, null, 2)); // Log formatted JSON
                    console.log("FRONTEND: addProduct.html: X-User-Id header value:", window.loggedInUserId);

                    try {
                        const response = await fetch('/products', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-User-Id': window.loggedInUserId // Send logged-in user ID for backend validation
                            },
                            body: JSON.stringify(productData)
                        });

                        if (response.ok) {
                            console.log("FRONTEND: addProduct.html: Product added successfully!");
                            if (successModalOverlay) {
                                successModalOverlay.classList.remove('hidden');
                            } else {
                                showCustomMessageBox('Produto adicionado com sucesso!');
                            }
                        } else {
                            const errorText = await response.text();
                            let errorMessage = `Error: ${response.status} ${response.statusText}`;
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = `Error: ${errorJson.message || errorJson.error || JSON.stringify(errorJson)}`;
                            } catch (e) {
                                errorMessage = `Error: ${errorText}`;
                            }
                            console.error("FRONTEND: addProduct.html: Error adding product. Status:", response.status, "Error Text:", errorText);
                            showCustomMessageBox(errorMessage);
                        }
                    } catch (error) {
                        console.error("FRONTEND: addProduct.html: Network or unexpected error:", error);
                        showCustomMessageBox(`An unexpected error occurred: ${error.message}`);
                    }
                });
            } else {
                console.error("FRONTEND: addProduct.html: addProductForm element not found.");
            }
        });

        function showCustomMessageBox(message) {
            console.warn("Custom Message Box:", message);
            alert(message); // Fallback
        }
    </script>
</body>
</html>
