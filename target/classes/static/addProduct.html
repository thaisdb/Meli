<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product</title>
    <link rel="stylesheet" type="text/css" href="/css/page.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Link to the header.js script -->
    <script src="header.js" defer></script>
</head>
<body data-title="Add Product" data-show-profile-icon="true" data-show-search-bar="false">
    <div class="header-placeholder"></div>

    <div class="card add-product-card">
        <h2>Add New Product</h2>
        <form id="addProductForm">
            <div class="form-group">
                <label for="title">Título:</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="price">Preço:</label>
                <input type="number" id="price" name="price" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="description">Descrição:</label>
                <textarea id="description" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="brand">Marca:</label>
                <input type="text" id="brand" name="brand"></input>
            </div>
            <div class="form-group">
                <label for="stock">Quantidade em estoque:</label>
                <input type="number" id="stock" value="1" min="1" name="stock" required>
            </div>
            <div class="form-group">
                <label for="tags">Tags (separadas por ";"):</label>
                <input type="text" id="tags" name="tags">
            </div>
            <div class="form-group">
                <label for="imageUrl">URL da imagem:</label>
                <input type="text" id="imageUrl" name="imageUrl">
            </div>
            <button type="submit" class="button">Adicionar produto</button><br><br>
            <button class="button light-blue-button" onclick="location.href='/manageProducts.html'" type="button">Voltar para página de gerenciamento de produtos</button>
        </form>
    </div>

    <!-- NEW: Product Added Confirmation Modal - Now uses app-modal-overlay -->
    <div class="success-modal-overlay hidden app-modal-overlay">
        <div class="success-modal-content app-modal-content">
            <h2 class="success-modal-title app-modal-title">Produto adicionado com sucesso!</h2>
            <p class="success-modal-message app-modal-message">O que deseja fazer?</p>
            <div class="success-modal-actions app-modal-actions">
                <button id="goToManageProductsBtn" class="button light-blue-button">Voltar para o gerenciador de produtos</button>
                <button id="addMoreProductsBtn" class="button">Adicionar mais produtos</button>
            </div>
        </div>
    </div>

    <script>
        // DOM element references for the new modal
        let successModalOverlay;
        let addMoreProductsBtn;
        let goToManageProductsBtn;

        document.addEventListener('DOMContentLoaded', () => {
            const addProductForm = document.getElementById('addProductForm');
            
            // Initialize new modal elements
            successModalOverlay = document.querySelector('.success-modal-overlay');
            addMoreProductsBtn = document.getElementById('addMoreProductsBtn');
            goToManageProductsBtn = document.getElementById('goToManageProductsBtn');

            // Add event listeners for the new modal buttons
            if (addMoreProductsBtn) {
                addMoreProductsBtn.addEventListener('click', () => {
                    console.log("FRONTEND: addProduct.html: 'Add More Products' clicked.");
                    successModalOverlay.classList.add('hidden'); // Hide the modal
                    addProductForm.reset(); // Clear the form
                });
            }

            if (goToManageProductsBtn) {
                goToManageProductsBtn.addEventListener('click', () => {
                    console.log("FRONTEND: addProduct.html: 'Go to Manage Products' clicked. Redirecting...");
                    successModalOverlay.classList.add('hidden'); // Hide the modal
                    window.location.href = '/manageProducts.html'; // Redirect
                });
            }

            if (addProductForm) {
                addProductForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    const formData = new FormData(addProductForm);
                    const productData = {};
                    formData.forEach((value, key) => {
                        // Convert price and stock to numbers
                        if (key === 'price' || key === 'stock') {
                            productData[key] = parseFloat(value);
                        } else if (key === 'tags') {
                            // Split tags by SEMICOLON and filter out empty strings
                            productData[key] = value.split(';').map(tag => tag.trim()).filter(tag => tag !== '');
                        } else {
                            productData[key] = value;
                        }
                    });

                    // DEBUGGING: Log the productData object before sending
                    console.log("FRONTEND: addProduct.html: Product data being sent:", productData);
                    console.log("FRONTEND: addProduct.html: JSON stringified data:", JSON.stringify(productData));

                    try {
                        const response = await fetch('/products', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(productData)
                        });

                        if (response.ok) {
                            console.log("FRONTEND: addProduct.html: Product added successfully!");
                            // Show the custom success modal
                            if (successModalOverlay) {
                                successModalOverlay.classList.remove('hidden');
                            } else {
                                alert('Product added successfully!'); // Fallback if modal not found
                            }
                        } else {
                            const errorText = await response.text(); // Get raw text to avoid JSON parsing issues on error
                            let errorMessage = `Error: ${response.status} ${response.statusText}`;
                            try {
                                const errorJson = JSON.parse(errorText);
                                errorMessage = `Error: ${errorJson.message || errorJson.error || JSON.stringify(errorJson)}`;
                            } catch (e) {
                                errorMessage = `Error: ${errorText}`; // Fallback to raw text if not JSON
                            }
                            console.error("FRONTEND: addProduct.html: Error adding product. Status:", response.status, "Error Text:", errorText);
                            showCustomMessageBox(errorMessage);
                        }
                    } catch (error) {
                        console.error("FRONTEND: addProduct.html: Network or unexpected error:", error);
                        showCustomMessageBox(`An unexpected error occurred: ${error.message}`);
                    }
                });
            } else {
                console.error("FRONTEND: addProduct.html: addProductForm element not found.");
            }
        });

        // Placeholder for a custom message box (replace alert for errors)
        function showCustomMessageBox(message) {
            console.warn("Custom Message Box (Error):", message);
            alert(message); // For now, using alert for quick feedback, but replace with custom UI
        }
    </script>
</body>
</html>
