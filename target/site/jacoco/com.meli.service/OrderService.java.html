<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prototype</a> &gt; <a href="index.source.html" class="el_package">com.meli.service</a> &gt; <span class="el_source">OrderService.java</span></div><h1>OrderService.java</h1><pre class="source lang-java linenums">package com.meli.service;

import com.meli.model.Consumer;
import com.meli.model.Order;
import com.meli.model.Product;
import com.meli.model.OrderStatus;
import com.meli.model.PaymentMethod;
import com.meli.model.Seller;
import com.meli.model.User;
import com.meli.repository.OrderRepository;
import com.meli.repository.UserRepository;
import com.meli.dto.BuyRequestDTO;
import com.meli.dto.OrderProductDetailDTO;
import com.meli.dto.OrderSummaryDTO;
import com.meli.dto.SellerOrderDTO;

import org.springframework.stereotype.Service;

import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

/*
 * Contém a lógica de negócio para a criação e gerenciamento de pedidos.
 * Ele orquestra as operações necessárias para transformar os itens do carrinho em um pedido final
 */
@Service
public class OrderService {

    private final OrderRepository orderRepository;
    private final UserService userService;
    private final ProductService productService;

<span class="nc" id="L38">    public OrderService(OrderRepository orderRepository, UserService userService, ProductService productService) {</span>
<span class="nc" id="L39">        this.orderRepository = orderRepository;</span>
<span class="nc" id="L40">        this.userService = userService;</span>
<span class="nc" id="L41">        this.productService = productService;</span>
<span class="nc" id="L42">    }</span>

    /**
     * Cria um novo pedido de produto.
     * Este método agora lida com a lógica de um único pedido por vez,
     * determinando o vendedor e os detalhes do pedido.
     * @param purchaseItems Lista de BuyRequestDTOs (productId e quantity).
     * @param consumerId ID do consumidor que está fazendo a compra.
     * @return Optional de Order se o pedido for criado com sucesso, Optional.empty() caso contrário.
     */
    public Optional&lt;Order&gt; createProductOrder(List&lt;BuyRequestDTO&gt; purchaseItems, int consumerId) {
        // Validação do consumidor
<span class="nc" id="L54">        User user = userService.getUserById(consumerId);</span>
<span class="nc bnc" id="L55" title="All 4 branches missed.">        if (user == null || !(user instanceof Consumer)) {</span>
<span class="nc" id="L56">            System.err.println(&quot;ERROR: OrderService - Consumidor com ID &quot; + consumerId + &quot; não encontrado ou não é do tipo Consumidor.&quot;);</span>
<span class="nc" id="L57">            return Optional.empty();</span>
        }
<span class="nc" id="L59">        Consumer consumer = (Consumer) user;</span>

        // Agrupa produtos por vendedor para criar um pedido por vendedor
<span class="nc" id="L62">        Map&lt;Integer, List&lt;BuyRequestDTO&gt;&gt; itemsBySeller = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        for (BuyRequestDTO item : purchaseItems) {</span>
<span class="nc" id="L64">            Product product = productService.getProductById(item.getId());</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (product == null) {</span>
<span class="nc" id="L66">                System.err.println(&quot;ERROR: OrderService - Produto com ID &quot; + item.getId() + &quot; não encontrado durante a criação do pedido.&quot;);</span>
<span class="nc" id="L67">                return Optional.empty(); // Ou lidar com erro de forma diferente</span>
            }
<span class="nc" id="L69">            itemsBySeller.computeIfAbsent(product.getSellerId(), k -&gt; new ArrayList&lt;&gt;()).add(item);</span>
<span class="nc" id="L70">        }</span>

<span class="nc" id="L72">        Order createdOrder = null;</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">        for (Map.Entry&lt;Integer, List&lt;BuyRequestDTO&gt;&gt; entry : itemsBySeller.entrySet()) {</span>
<span class="nc" id="L75">            int sellerId = entry.getKey();</span>
<span class="nc" id="L76">            List&lt;BuyRequestDTO&gt; sellerSpecificItems = entry.getValue();</span>

            // Validação do vendedor
<span class="nc" id="L79">            User sellerUser = userService.getUserById(sellerId);</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">            if (sellerUser == null || !(sellerUser instanceof Seller)) {</span>
<span class="nc" id="L81">                System.err.println(&quot;ERROR: OrderService - Vendedor com ID &quot; + sellerId + &quot; não encontrado ou não é do tipo Vendedor.&quot;);</span>
<span class="nc" id="L82">                return Optional.empty();</span>
            }

<span class="nc" id="L85">            Map&lt;Integer, Integer&gt; productsInOrder = new HashMap&lt;&gt;();</span>
<span class="nc" id="L86">            double totalAmount = 0.0;</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">            for (BuyRequestDTO item : sellerSpecificItems) {</span>
<span class="nc" id="L89">                Product product = productService.getProductById(item.getId());</span>
<span class="nc" id="L90">                productsInOrder.put(item.getId(), item.getQuantity());</span>
<span class="nc" id="L91">                totalAmount += product.getPrice() * item.getQuantity(); // Usar preço atual do produto</span>
<span class="nc" id="L92">            }</span>

<span class="nc" id="L94">            Order newOrder = new Order();</span>
<span class="nc" id="L95">            newOrder.setConsumerId(consumerId);</span>
<span class="nc" id="L96">            newOrder.setSellerId(sellerId);</span>
<span class="nc" id="L97">            newOrder.setProducts(productsInOrder);</span>
<span class="nc" id="L98">            newOrder.setTimestamp(ZonedDateTime.now());</span>
<span class="nc" id="L99">            newOrder.setTotal(totalAmount);</span>
<span class="nc" id="L100">            newOrder.setShippingCost(0.0); // Assumindo custo de envio 0 por padrão</span>
<span class="nc" id="L101">            newOrder.setPaymentMethod(consumer.getPreferredPaymentMethod());</span>
<span class="nc" id="L102">            newOrder.setStatus(OrderStatus.COMPLETED);</span>

<span class="nc" id="L104">            orderRepository.save(newOrder);</span>
<span class="nc" id="L105">            System.out.println(&quot;DEBUG: OrderService - Pedido criado com sucesso para o consumidor &quot; + consumerId + &quot; e vendedor &quot; + sellerId + &quot;. ID do pedido: &quot; + newOrder.getId());</span>
<span class="nc" id="L106">            createdOrder = newOrder;</span>
<span class="nc" id="L107">        }</span>
        
<span class="nc" id="L109">        return Optional.ofNullable(createdOrder);</span>
    }

    /**
     * Obtém todos os pedidos.
     * @return Lista de todos os pedidos.
     */
    public List&lt;Order&gt; getAllOrders() {
<span class="nc" id="L117">        return orderRepository.getAll();</span>
    }

    /**
     * Obtém um pedido pelo seu ID.
     * @param id ID do pedido.
     * @return Optional de Order se encontrado, Optional.empty() caso contrário.
     */
    public Optional&lt;Order&gt; getOrderById(int id) {
<span class="nc" id="L126">        return orderRepository.getById(id);</span>
    }

    /**
     * Obtém pedidos de um consumidor específico e os converte para OrderSummaryDTO.
     * Inclui a lista de detalhes dos produtos (OrderProductDetailDTO) e a contagem de itens no DTO.
     * @param consumerId O ID do consumidor.
     * @return Uma lista de OrderSummaryDTOs feitos pelo consumidor.
     */
    public List&lt;OrderSummaryDTO&gt; getOrdersByConsumerId(int consumerId) {
<span class="nc" id="L136">        System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Buscando pedidos para o consumidor ID: &quot; + consumerId);</span>
<span class="nc" id="L137">        List&lt;Order&gt; consumerOrders = orderRepository.getAll().stream()</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                                            .filter(order -&gt; order.getConsumerId() == consumerId)</span>
<span class="nc" id="L139">                                            .collect(Collectors.toList());</span>

<span class="nc" id="L141">        List&lt;OrderSummaryDTO&gt; responseDTOs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        for (Order order : consumerOrders) {</span>
<span class="nc" id="L143">            System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Processando pedido ID: &quot; + order.getId() + &quot;, Consumer ID: &quot; + order.getConsumerId());</span>
<span class="nc" id="L144">            System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Produtos no pedido (mapa): &quot; + order.getProducts());</span>

            // Calcula itemCount a partir do mapa de produtos
<span class="nc" id="L147">            int itemCount = order.getProducts().values().stream().mapToInt(Integer::intValue).sum();</span>
            
            // Constrói a lista de OrderProductDetailDTOs
<span class="nc" id="L150">            List&lt;OrderProductDetailDTO&gt; productsDetails = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">            if (order.getProducts() != null &amp;&amp; !order.getProducts().isEmpty()) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                for (Map.Entry&lt;Integer, Integer&gt; entry : order.getProducts().entrySet()) {</span>
<span class="nc" id="L153">                    Integer productId = entry.getKey();</span>
<span class="nc" id="L154">                    Integer quantity = entry.getValue();</span>
<span class="nc" id="L155">                    System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Buscando detalhes para Produto ID: &quot; + productId + &quot;, Quantidade: &quot; + quantity);</span>

<span class="nc" id="L157">                    Product product = productService.getProductById(productId); // Busca o produto para obter detalhes</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">                    if (product != null) {</span>
<span class="nc" id="L160">                        System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Produto encontrado: &quot; + product.getTitle());</span>
<span class="nc" id="L161">                        productsDetails.add(new OrderProductDetailDTO(</span>
<span class="nc" id="L162">                            product.getId(),</span>
<span class="nc" id="L163">                            product.getTitle(),</span>
<span class="nc" id="L164">                            quantity,</span>
<span class="nc" id="L165">                            product.getImageUrl()</span>
                        ));
                    } else {
<span class="nc" id="L168">                        System.err.println(&quot;WARNING: OrderService.getOrdersByConsumerId - Produto com ID &quot; + productId + &quot; NÃO ENCONTRADO no ProductService para o pedido &quot; + order.getId() + &quot;. Usando placeholder.&quot;);</span>
<span class="nc" id="L169">                        productsDetails.add(new OrderProductDetailDTO(</span>
<span class="nc" id="L170">                            productId,</span>
                            &quot;Produto Desconhecido (ID: &quot; + productId + &quot;)&quot;, // Adiciona o ID para depuração no frontend
<span class="nc" id="L172">                            quantity,</span>
                            &quot;https://placehold.co/40x40/e0e0e0/333333?text=N/A&quot;
                        ));
                    }
<span class="nc" id="L176">                }</span>
            } else {
<span class="nc" id="L178">                System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Mapa de produtos vazio ou nulo para o pedido ID: &quot; + order.getId());</span>
            }


<span class="nc" id="L182">            responseDTOs.add(new OrderSummaryDTO(</span>
<span class="nc" id="L183">                order.getId(),</span>
<span class="nc" id="L184">                order.getConsumerId(),</span>
<span class="nc" id="L185">                order.getSellerId(),</span>
                productsDetails, // Passa a lista de detalhes dos produtos
                itemCount, // Passa a contagem de itens
<span class="nc" id="L188">                order.getShippingAddress(),</span>
<span class="nc" id="L189">                order.getTotal(),</span>
<span class="nc" id="L190">                order.getShippingCost(),</span>
<span class="nc" id="L191">                order.getPaymentMethod(),</span>
<span class="nc" id="L192">                order.getStatus(),</span>
<span class="nc" id="L193">                order.getTimestamp()</span>
            ));
<span class="nc" id="L195">        }</span>

<span class="nc" id="L197">        System.out.println(&quot;DEBUG: OrderService.getOrdersByConsumerId - Encontrados &quot; + responseDTOs.size() + &quot; pedidos (DTOs de resumo) para o consumidor ID: &quot; + consumerId);</span>
<span class="nc" id="L198">        return responseDTOs;</span>
    }

    /**
     * Obtém pedidos que contêm produtos de um vendedor específico.
     * Retorna uma lista de SellerOrderDTOs, que incluem apenas os itens do vendedor em cada pedido.
     * @param sellerId ID do vendedor.
     * @return Lista de SellerOrderDTOs.
     */
    public List&lt;SellerOrderDTO&gt; getOrdersBySellerId(int sellerId) {
<span class="nc" id="L208">        List&lt;Order&gt; allOrders = orderRepository.getAll();</span>
<span class="nc" id="L209">        List&lt;SellerOrderDTO&gt; sellerOrders = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">        for (Order order : allOrders) {</span>
            // Filtra apenas os pedidos onde este vendedor é o sellerId
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (order.getSellerId() != sellerId) {</span>
<span class="nc" id="L214">                continue;</span>
            }

<span class="nc" id="L217">            List&lt;Map&lt;String, Object&gt;&gt; sellerItemsInOrder = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L218">            double currentOrderSellerAmount = 0.0;</span>

            // Itera sobre os produtos dentro do mapa 'products' do pedido
<span class="nc bnc" id="L221" title="All 2 branches missed.">            for (Map.Entry&lt;Integer, Integer&gt; entry : order.getProducts().entrySet()) {</span>
<span class="nc" id="L222">                Integer productId = entry.getKey();</span>
<span class="nc" id="L223">                Integer quantity = entry.getValue();</span>
<span class="nc" id="L224">                Product product = productService.getProductById(productId);</span>

                // Verifica se o produto existe (já sabemos que pertence a este vendedor pelo filtro acima)
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (product != null) {</span>
<span class="nc" id="L228">                    Map&lt;String, Object&gt; itemDetails = new HashMap&lt;&gt;();</span>
<span class="nc" id="L229">                    itemDetails.put(&quot;productId&quot;, product.getId());</span>
<span class="nc" id="L230">                    itemDetails.put(&quot;title&quot;, product.getTitle());</span>
<span class="nc" id="L231">                    itemDetails.put(&quot;quantity&quot;, quantity);</span>
<span class="nc" id="L232">                    itemDetails.put(&quot;priceAtPurchase&quot;, product.getPrice());</span>
<span class="nc" id="L233">                    itemDetails.put(&quot;totalItemAmount&quot;, quantity * product.getPrice());</span>
<span class="nc" id="L234">                    sellerItemsInOrder.add(itemDetails);</span>
<span class="nc" id="L235">                    currentOrderSellerAmount += (quantity * product.getPrice());</span>
                }
<span class="nc" id="L237">            }</span>

            // Se o pedido contém produtos deste vendedor, adiciona-o à lista de pedidos do vendedor
<span class="nc bnc" id="L240" title="All 2 branches missed.">            if (!sellerItemsInOrder.isEmpty()) {</span>
<span class="nc" id="L241">                sellerOrders.add(new SellerOrderDTO(</span>
<span class="nc" id="L242">                    order.getId(),</span>
<span class="nc" id="L243">                    order.getConsumerId(),</span>
<span class="nc" id="L244">                    order.getTimestamp(),</span>
<span class="nc" id="L245">                    order.getStatus().name(),</span>
                    currentOrderSellerAmount, // MUDANÇA AQUI: Usar currentOrderSellerAmount
                    sellerItemsInOrder
                ));
            }
<span class="nc" id="L250">        }</span>
<span class="nc" id="L251">        System.out.println(&quot;DEBUG: OrderService.getOrdersBySellerId - Encontrados &quot; + sellerOrders.size() + &quot; pedidos para o vendedor ID: &quot; + sellerId);</span>
<span class="nc" id="L252">        return sellerOrders;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>