<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prototype</a> &gt; <a href="index.source.html" class="el_package">com.meli.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.meli.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.type.CollectionType;
import com.meli.model.User;
import com.meli.model.Consumer; 
import com.meli.model.Seller;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional; // Importar Optional

/*
 * Encapsulates business logic related to User management
 * Handles loading/saving/registering/updating and searching users via Jackson
 * Delegate persistance to UserRepository
 *
 */
@Service
public class UserService {
<span class="nc" id="L24">    private final String DATA_FILE_PATH = &quot;data/users.json&quot;;</span>
<span class="nc" id="L25">    private List&lt;User&gt; users = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L26">    private final ObjectMapper mapper = new ObjectMapper();</span>

<span class="nc" id="L28">    public UserService() {</span>
        // Configurar ObjectMapper para lidar com polimorfismo
<span class="nc" id="L30">        mapper.registerSubtypes(Consumer.class, Seller.class);</span>
<span class="nc" id="L31">        loadUsers();</span>
<span class="nc" id="L32">    }</span>

    private void loadUsers() {
<span class="nc" id="L35">        System.out.println(&quot;DEBUG: UserService.loadUsers - Trying to load users from: &quot; + new File(DATA_FILE_PATH).getAbsolutePath());</span>
        try {
<span class="nc" id="L37">            File file = new File(DATA_FILE_PATH);</span>
<span class="nc bnc" id="L38" title="All 4 branches missed.">            if (file.exists() &amp;&amp; file.length() &gt; 0) { // Verifica se o arquivo existe e não está vazio</span>
<span class="nc" id="L39">                CollectionType listType = mapper.getTypeFactory().constructCollectionType(List.class, User.class);</span>
<span class="nc" id="L40">                users = mapper.readValue(file, listType);</span>
<span class="nc" id="L41">                System.out.println(&quot;DEBUG: UserService.loadUsers - Successfully loaded &quot; + users.size() + &quot; users.&quot;);</span>
<span class="nc" id="L42">            } else {</span>
<span class="nc" id="L43">                System.out.println(&quot;DEBUG: UserService.loadUsers - No user file found or file is empty. Starting with empty list.&quot;);</span>
<span class="nc" id="L44">                users = new ArrayList&lt;&gt;();</span>
            }
<span class="nc" id="L46">        } catch (IOException e) {</span>
<span class="nc" id="L47">            System.err.println(&quot;ERROR: UserService.loadUsers - Failed to load users from file: &quot; + e.getMessage());</span>
<span class="nc" id="L48">            e.printStackTrace(); // Print stack trace for detailed error info</span>
<span class="nc" id="L49">            users = new ArrayList&lt;&gt;(); // Garante que a lista não seja nula em caso de erro</span>
<span class="nc" id="L50">        }</span>
<span class="nc" id="L51">    }</span>

    private void saveUsers() {
<span class="nc" id="L54">        System.out.println(&quot;DEBUG: UserService.saveUsers - Attempting to save &quot; + users.size() + &quot; users to file.&quot;);</span>
        try {
<span class="nc" id="L56">            File file = new File(DATA_FILE_PATH);</span>
<span class="nc" id="L57">            File parentDir = file.getParentFile();</span>
<span class="nc bnc" id="L58" title="All 4 branches missed.">            if (parentDir != null &amp;&amp; !parentDir.exists()) {</span>
<span class="nc" id="L59">                parentDir.mkdirs(); // Cria o diretório 'data' se não existir</span>
            }
<span class="nc" id="L61">            mapper.writerWithDefaultPrettyPrinter().writeValue(file, users);</span>
<span class="nc" id="L62">            System.out.println(&quot;DEBUG: UserService.saveUsers - Users saved successfully.&quot;);</span>
<span class="nc" id="L63">        } catch (IOException e) {</span>
<span class="nc" id="L64">            System.err.println(&quot;ERROR: UserService.saveUsers - Failed to save users to file: &quot; + e.getMessage());</span>
<span class="nc" id="L65">            e.printStackTrace();</span>
<span class="nc" id="L66">        }</span>
<span class="nc" id="L67">    }</span>

    /**
     * Register a new user (assigns a unique ID and saves)
     * Returns Optional.empty() if email already exists.
     */
    public Optional&lt;User&gt; registerUser(User user) { 
        // Verificar se o email já existe
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (findByEmail(user.getEmail()) != null) { // Usando o método findByEmail existente</span>
<span class="nc" id="L76">            System.out.println(&quot;DEBUG: UserService.registerUser - Registration failed: Email already exists.&quot;);</span>
<span class="nc" id="L77">            return Optional.empty(); // Email já existe</span>
        }

        // Você pode adicionar validação para CPF único aqui se for um requisito
        // if (findByCpf(user.getCpf()) != null) { ... }

<span class="nc" id="L83">        int newId = generateNextId();</span>
<span class="nc" id="L84">        user.setId(newId);</span>
<span class="nc" id="L85">        users.add(user);</span>
<span class="nc" id="L86">        saveUsers();</span>
<span class="nc" id="L87">        System.out.println(&quot;DEBUG: UserService.registerUser - Registered new user: &quot; + user.getEmail() + &quot; with ID: &quot; + user.getId());</span>
<span class="nc" id="L88">        return Optional.of(user); // Retorna o usuário salvo</span>
    }

    public List&lt;User&gt; getAllUsers() {
<span class="nc" id="L92">        return new ArrayList&lt;&gt;(users); // Retorna uma cópia para evitar modificações externas</span>
    }

    public User getUserById(int id) {
<span class="nc" id="L96">        System.out.println(&quot;DEBUG: UserService.getUserById - Searching for user with ID: &quot; + id);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        User foundUser = users.stream().filter(u -&gt; u.getId() == id).findFirst().orElse(null);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (foundUser != null) {</span>
<span class="nc" id="L99">            System.out.println(&quot;DEBUG: UserService.getUserById - Found user: &quot; + foundUser.getEmail());</span>
        } else {
<span class="nc" id="L101">            System.out.println(&quot;DEBUG: UserService.getUserById - User with ID &quot; + id + &quot; not found.&quot;);</span>
        }
<span class="nc" id="L103">        return foundUser;</span>
    }

    public boolean deleteUserById(int id) {
<span class="nc" id="L107">        System.out.println(&quot;DEBUG: UserService.deleteUserById - Attempting to delete user with ID: &quot; + id);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        boolean removed = users.removeIf(u -&gt; u.getId() == id);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (removed) {</span>
<span class="nc" id="L110">            saveUsers();</span>
<span class="nc" id="L111">            System.out.println(&quot;DEBUG: UserService.deleteUserById - User with ID &quot; + id + &quot; removed successfully.&quot;);</span>
        } else {
<span class="nc" id="L113">            System.out.println(&quot;DEBUG: UserService.deleteUserById - User with ID &quot; + id + &quot; not found for deletion.&quot;);</span>
        }
<span class="nc" id="L115">        return removed;</span>
    }

    /*
     * Find user by given email, used in login page and for uniqueness checks
     * @param email
     * @return User
     */
    public User findByEmail(String email) {
<span class="nc" id="L124">        System.out.println(&quot;DEBUG: UserService.findByEmail - Searching for email: '&quot; + email + &quot;'&quot;);</span>
<span class="nc" id="L125">        User user = users.stream()</span>
<span class="nc" id="L126">                .filter(u -&gt; u.getEmail().equalsIgnoreCase(email))</span>
<span class="nc" id="L127">                .findFirst()</span>
<span class="nc" id="L128">                .orElse(null);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (user != null) {</span>
<span class="nc" id="L130">            System.out.println(&quot;DEBUG: UserService.findByEmail - User found: &quot; + user.getEmail() + &quot; (ID: &quot; + user.getId() + &quot;)&quot;);</span>
        } else {
<span class="nc" id="L132">            System.out.println(&quot;DEBUG: UserService.findByEmail - User NOT found for email: '&quot; + email + &quot;'&quot;);</span>
        }
<span class="nc" id="L134">        return user;</span>
    }

    // REMOVIDO: findByUsername

    /*
     * Generate next Id based on last existing user record
     * @return unique Id
     */
    private int generateNextId() {
<span class="nc" id="L144">        return users.stream()</span>
<span class="nc" id="L145">                .mapToInt(User::getId)</span>
<span class="nc" id="L146">                .max()</span>
<span class="nc" id="L147">                .orElse(0) + 1;</span>
    }

    /**
     * Simulates password verification.
     * In a real application, use a secure password encoder (e.g., BCryptPasswordEncoder).
     *
     * @param rawPassword The password entered by the user.
     * @param storedPassword The password retrieved from the database.
     * @return true if passwords match, false otherwise.
     */
    public boolean verifyPassword(String rawPassword, String storedPassword) {
<span class="nc" id="L159">        System.out.println(&quot;DEBUG: UserService.verifyPassword - Raw Password: '&quot; + rawPassword + &quot;'&quot;);</span>
<span class="nc" id="L160">        System.out.println(&quot;DEBUG: UserService.verifyPassword - Stored Password: '&quot; + storedPassword + &quot;'&quot;);</span>
<span class="nc" id="L161">        boolean matches = rawPassword.equals(storedPassword);</span>
<span class="nc" id="L162">        System.out.println(&quot;DEBUG: UserService.verifyPassword - Passwords Match: &quot; + matches);</span>
<span class="nc" id="L163">        return matches;</span>
    }

    // NOVO MÉTODO: loginUser para ser usado pelo Controller
    public Optional&lt;User&gt; loginUser(String email, String password) {
<span class="nc" id="L168">        User user = findByEmail(email); // Usar findByEmail para login</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (user != null &amp;&amp; verifyPassword(password, user.getPassword())) {</span>
<span class="nc" id="L170">            return Optional.of(user);</span>
        }
<span class="nc" id="L172">        return Optional.empty();</span>
    }

    // NOVO MÉTODO: updateUser para ser usado pelo Controller
    public Optional&lt;User&gt; updateUser(User userDetails) {
<span class="nc" id="L177">        User existingUser = getUserById(userDetails.getId());</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (existingUser != null) {</span>
            // Verificar se o novo email já existe e não pertence ao usuário atual
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (!existingUser.getEmail().equalsIgnoreCase(userDetails.getEmail())) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (findByEmail(userDetails.getEmail()) != null) {</span>
<span class="nc" id="L182">                    System.out.println(&quot;DEBUG: UserService - Update failed: Email already in use by another user.&quot;);</span>
<span class="nc" id="L183">                    return Optional.empty(); // Email já em uso por outro usuário</span>
                }
            }

            // REMOVIDO: Lógica de verificação de username

            // Atualizar os campos permitidos
<span class="nc" id="L190">            existingUser.setName(userDetails.getName());</span>
<span class="nc" id="L191">            existingUser.setEmail(userDetails.getEmail());</span>
<span class="nc" id="L192">            existingUser.setCpf(userDetails.getCpf());</span>
<span class="nc" id="L193">            existingUser.setAddress(userDetails.getAddress()); // Atualizar endereço</span>

            // A senha só deve ser atualizada se for fornecida (e não vazia)
<span class="nc bnc" id="L196" title="All 4 branches missed.">            if (userDetails.getPassword() != null &amp;&amp; !userDetails.getPassword().isEmpty()) {</span>
<span class="nc" id="L197">                existingUser.setPassword(userDetails.getPassword());</span>
            }

<span class="nc bnc" id="L200" title="All 4 branches missed.">            if (existingUser instanceof Consumer &amp;&amp; userDetails instanceof Consumer) {</span>
<span class="nc" id="L201">                Consumer existingConsumer = (Consumer) existingUser;</span>
<span class="nc" id="L202">                Consumer updatedConsumerDetails = (Consumer) userDetails;</span>
<span class="nc" id="L203">                existingConsumer.setPreferredPaymentMethod(updatedConsumerDetails.getPreferredPaymentMethod());</span>
<span class="nc" id="L204">                System.out.println(&quot;DEBUG: UserService - Updated preferredPaymentMethod for Consumer ID &quot; + existingConsumer.getId() + &quot; to: &quot; + existingConsumer.getPreferredPaymentMethod());</span>
            }
        
<span class="nc" id="L207">            saveUsers(); // Salva as alterações</span>
<span class="nc" id="L208">            return Optional.of(existingUser);</span>
        }
<span class="nc" id="L210">        System.out.println(&quot;DEBUG: UserService - Update failed: User with ID &quot; + userDetails.getId() + &quot; not found.&quot;);</span>
<span class="nc" id="L211">        return Optional.empty();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>