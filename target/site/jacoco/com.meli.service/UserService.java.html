<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Prototype</a> &gt; <a href="index.source.html" class="el_package">com.meli.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.meli.service;

import com.meli.model.User;
import com.meli.model.Consumer;
import com.meli.model.Seller;
import com.meli.repository.UserRepository; // Importar UserRepository
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
public class UserService {
    // REMOVIDO: private final String DATA_FILE_PATH = &quot;data/users.json&quot;;
    // REMOVIDO: private List&lt;User&gt; users = new ArrayList&lt;&gt;();
    // REMOVIDO: private final ObjectMapper mapper = new ObjectMapper();

    private final UserRepository userRepository; // Injetar UserRepository

<span class="nc" id="L21">    public UserService(UserRepository userRepository) { // Construtor com injeção</span>
<span class="nc" id="L22">        this.userRepository = userRepository;</span>
        // REMOVIDO: mapper.registerSubtypes(Consumer.class, Seller.class);
        // REMOVIDO: loadUsers(); // UserRepository já faz isso
<span class="nc" id="L25">    }</span>

    // REMOVIDO: loadUsers()
    // REMOVIDO: saveUsers()
    // REMOVIDO: generateNextId()

    /**
     * Register a new user (assigns a unique ID and saves)
     * Returns Optional.empty() if email already exists.
     */
    public Optional&lt;User&gt; registerUser(User user) { 
        // Verificar se o email já existe usando o repositório
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (userRepository.findUserByEmail(user.getEmail()).isPresent()) {</span>
<span class="nc" id="L38">            System.out.println(&quot;DEBUG: UserService.registerUser - Registration failed: Email already exists.&quot;);</span>
<span class="nc" id="L39">            return Optional.empty(); // Email já existe</span>
        }

        // O ID será gerado e atribuído pelo UserRepository.save()
<span class="nc" id="L43">        userRepository.save(user); // Delega ao UserRepository</span>
<span class="nc" id="L44">        System.out.println(&quot;DEBUG: UserService.registerUser - Registered new user: &quot; + user.getEmail() + &quot; with ID: &quot; + user.getId());</span>
<span class="nc" id="L45">        return Optional.of(user); // Retorna o usuário salvo (com ID atribuído pelo repo)</span>
    }

    public List&lt;User&gt; getAllUsers() {
<span class="nc" id="L49">        return userRepository.getAll(); // Delega ao UserRepository</span>
    }

    public User getUserById(int id) {
<span class="nc" id="L53">        System.out.println(&quot;DEBUG: UserService.getUserById - Searching for user with ID: &quot; + id);</span>
<span class="nc" id="L54">        User foundUser = userRepository.getById(id); // Delega ao UserRepository</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (foundUser != null) {</span>
<span class="nc" id="L56">            System.out.println(&quot;DEBUG: UserService.getUserById - Found user: &quot; + foundUser.getEmail());</span>
        } else {
<span class="nc" id="L58">            System.out.println(&quot;DEBUG: UserService.getUserById - User with ID &quot; + id + &quot; not found.&quot;);</span>
        }
<span class="nc" id="L60">        return foundUser;</span>
    }

    public boolean deleteUserById(int id) {
<span class="nc" id="L64">        System.out.println(&quot;DEBUG: UserService.deleteUserById - Attempting to delete user with ID: &quot; + id);</span>
<span class="nc" id="L65">        boolean removed = userRepository.deleteById(id); // Delega ao UserRepository</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (removed) {</span>
<span class="nc" id="L67">            System.out.println(&quot;DEBUG: UserService.deleteUserById - User with ID &quot; + id + &quot; removed successfully.&quot;);</span>
        } else {
<span class="nc" id="L69">            System.out.println(&quot;DEBUG: UserService.deleteUserById - User with ID &quot; + id + &quot; not found for deletion.&quot;);</span>
        }
<span class="nc" id="L71">        return removed;</span>
    }

    public User findByEmail(String email) {
<span class="nc" id="L75">        System.out.println(&quot;DEBUG: UserService.findByEmail - Searching for email: '&quot; + email + &quot;'&quot;);</span>
<span class="nc" id="L76">        Optional&lt;User&gt; user = userRepository.findUserByEmail(email); // Delega ao UserRepository</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (user.isPresent()) {</span>
<span class="nc" id="L78">            System.out.println(&quot;DEBUG: UserService.findByEmail - User found: &quot; + user.get().getEmail() + &quot; (ID: &quot; + user.get().getId() + &quot;)&quot;);</span>
<span class="nc" id="L79">            return user.get();</span>
        } else {
<span class="nc" id="L81">            System.out.println(&quot;DEBUG: UserService.findByEmail - User NOT found for email: '&quot; + email + &quot;'&quot;);</span>
<span class="nc" id="L82">            return null;</span>
        }
    }

    public boolean verifyPassword(String rawPassword, String storedPassword) {
<span class="nc" id="L87">        System.out.println(&quot;DEBUG: UserService.verifyPassword - Raw Password: '&quot; + rawPassword + &quot;'&quot;);</span>
<span class="nc" id="L88">        System.out.println(&quot;DEBUG: UserService.verifyPassword - Stored Password: '&quot; + storedPassword + &quot;'&quot;);</span>
<span class="nc" id="L89">        boolean matches = rawPassword.equals(storedPassword);</span>
<span class="nc" id="L90">        System.out.println(&quot;DEBUG: UserService.verifyPassword - Passwords Match: &quot; + matches);</span>
<span class="nc" id="L91">        return matches;</span>
    }

    public Optional&lt;User&gt; loginUser(String email, String password) {
<span class="nc" id="L95">        User user = findByEmail(email);</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (user != null &amp;&amp; verifyPassword(password, user.getPassword())) {</span>
<span class="nc" id="L97">            return Optional.of(user);</span>
        }
<span class="nc" id="L99">        return Optional.empty();</span>
    }

    public Optional&lt;User&gt; updateUser(User userDetails) {
<span class="nc" id="L103">        User existingUser = getUserById(userDetails.getId());</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (existingUser != null) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (!existingUser.getEmail().equalsIgnoreCase(userDetails.getEmail())) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (findByEmail(userDetails.getEmail()) != null) {</span>
<span class="nc" id="L107">                    System.out.println(&quot;DEBUG: UserService - Update failed: Email already in use by another user.&quot;);</span>
<span class="nc" id="L108">                    return Optional.empty();</span>
                }
            }

<span class="nc" id="L112">            existingUser.setName(userDetails.getName());</span>
<span class="nc" id="L113">            existingUser.setEmail(userDetails.getEmail());</span>
<span class="nc" id="L114">            existingUser.setCpf(userDetails.getCpf());</span>
<span class="nc" id="L115">            existingUser.setAddress(userDetails.getAddress());</span>

<span class="nc bnc" id="L117" title="All 4 branches missed.">            if (userDetails.getPassword() != null &amp;&amp; !userDetails.getPassword().isEmpty()) {</span>
<span class="nc" id="L118">                existingUser.setPassword(userDetails.getPassword());</span>
            }

<span class="nc bnc" id="L121" title="All 4 branches missed.">            if (existingUser instanceof Consumer &amp;&amp; userDetails instanceof Consumer) {</span>
<span class="nc" id="L122">                Consumer existingConsumer = (Consumer) existingUser;</span>
<span class="nc" id="L123">                Consumer updatedConsumerDetails = (Consumer) userDetails;</span>
<span class="nc" id="L124">                existingConsumer.setPreferredPaymentMethod(updatedConsumerDetails.getPreferredPaymentMethod());</span>
<span class="nc" id="L125">                System.out.println(&quot;DEBUG: UserService - Updated preferredPaymentMethod for Consumer ID &quot; + existingConsumer.getId() + &quot; to: &quot; + existingConsumer.getPreferredPaymentMethod());</span>
            }
            
<span class="nc" id="L128">            userRepository.save(existingUser); // Delega ao UserRepository para salvar a atualização</span>
<span class="nc" id="L129">            return Optional.of(existingUser);</span>
        }
<span class="nc" id="L131">        System.out.println(&quot;DEBUG: UserService - Update failed: User with ID &quot; + userDetails.getId() + &quot; not found.&quot;);</span>
<span class="nc" id="L132">        return Optional.empty();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>